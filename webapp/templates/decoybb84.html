{% extends "base.html" %}
{% load static %}
{% block title %}Decoy State QKD Simulator{% endblock %}

{% block content %}

<!-- Full-page loading overlay -->
<div id="pageLoadingOverlay" style="display: none; position: fixed; width: 100%; height: 100%; top: 0; left: 0; background-color: rgba(255, 255, 255, 0.7); backdrop-filter: blur(3px); z-index: 2000;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
        </div>
        <p class="mt-3" style="margin-top: 15px; font-weight: 500;">Running simulation, please wait...</p>
    </div>
</div>
<h1 class="text-center mb-4">Decoy State QKD Simulator</h1>
<div class="row">
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h3>Simulation Parameters</h3>
            </div>
            <div class="card-body">
                <form method="post" id="simulationForm">
                    {% csrf_token %}
                    
                    <h5>Optical Parameters</h5>
                    <div class="form-group">
                        <label for="wavelength">Wavelength (nm):</label>
                        <input type="number" class="form-control" id="wavelength" name="wavelength" value="1550" step="1">
                    </div>
                    <div class="form-group">
                        <label for="alpha">Fiber Loss Coefficient (dB/km):</label>
                        <input type="number" class="form-control" id="alpha" name="alpha" value="0.21" step="0.01">
                    </div>
                    
                    <h5>Detection Parameters</h5>
                    <div class="form-group">
                        <label for="e_detector">Detector Error Probability:</label>
                        <input type="number" class="form-control" id="e_detector" name="e_detector" value="0.033" step="0.001">
                    </div>
                    <div class="form-group">
                        <label for="Y0">Background Rate:</label>
                        <input type="number" class="form-control" id="Y0" name="Y0" value="0.0000017" step="0.0000001">
                    </div>
                    <div class="form-group">
                        <label for="eta_bob">Bob's Side Efficiency:</label>
                        <input type="number" class="form-control" id="eta_bob" name="eta_bob" value="0.045" step="0.001">
                    </div>
                    
                    <h5>Intensity Settings</h5>
                    <div class="form-group">
                        <label for="mu">Signal State Intensity (μ):</label>
                        <input type="number" class="form-control" id="mu" name="mu" value="0.5" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="nu1">Decoy State 1 Intensity (ν₁):</label>
                        <input type="number" class="form-control" id="nu1" name="nu1" value="0.1" step="0.01">
                    </div>
                    <div class="form-group">
                        <label for="nu2">Decoy State 2 Intensity (ν₂):</label>
                        <input type="number" class="form-control" id="nu2" name="nu2" value="0.0" step="0.01">
                    </div>
                    
                    <h5>Protocol Parameters</h5>
                    <div class="form-group">
                        <label for="f">Error Correction Efficiency:</label>
                        <input type="number" class="form-control" id="f" name="f" value="1.22" step="0.01">
                    </div>
                    <div class="form-group">
                        <label for="q">Protocol Efficiency Factor:</label>
                        <input type="number" class="form-control" id="q" name="q" value="0.5" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="rep_rate">Repetition Rate (Hz):</label>
                        <input type="number" class="form-control" id="rep_rate" name="rep_rate" value="2000000" step="100000">
                    </div>
                    
                    <h5>Simulation Range Parameters</h5>
                    <div class="form-group">
                        <label for="max_distance">Maximum Distance for Plots (km):</label>
                        <input type="number" class="form-control" id="max_distance" name="max_distance" value="150" step="10">
                    </div>
                    <div class="form-group">
                        <label for="selected_distance">Distance for Intensity Analysis (km):</label>
                        <input type="number" class="form-control" id="selected_distance" name="selected_distance" value="50" step="5">
                    </div>
                    <div class="form-group">
                        <label for="mu_min">Minimum μ for plots:</label>
                        <input type="number" class="form-control" id="mu_min" name="mu_min" value="0.1" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="mu_max">Maximum μ for plots:</label>
                        <input type="number" class="form-control" id="mu_max" name="mu_max" value="1.0" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="mu_step">μ Step Size:</label>
                        <input type="number" class="form-control" id="mu_step" name="mu_step" value="0.05" step="0.01">
                    </div>
                    <div class="form-group">
                        <label for="nu1_min">Minimum ν₁ for plots:</label>
                        <input type="number" class="form-control" id="nu1_min" name="nu1_min" value="0.01" step="0.01">
                    </div>
                    <div class="form-group">
                        <label for="nu1_max">Maximum ν₁ for plots:</label>
                        <input type="number" class="form-control" id="nu1_max" name="nu1_max" value="0.3" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="nu1_step">ν₁ Step Size:</label>
                        <input type="number" class="form-control" id="nu1_step" name="nu1_step" value="0.02" step="0.01">
                    </div>
                    
                    <button type="submit" class="btn btn-primary w-100 mt-3">Run Simulation</button>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-8">
        {% if plots %}
        <div class="card">
            <div class="card-header">
                <h3>Simulation Results</h3>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <h5>Performance Metrics:</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Current Key Rate:</strong> {{ current_rate }} bits/s</p>
                            <p><strong>Current QBER:</strong> {{ current_qber }}%</p>
                            <p><strong>Single Photon Yield (Y₁):</strong> {{ Y1_L }}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Single Photon Error Rate (e₁):</strong> {{ e1_U }}</p>
                            <p><strong>Optimal μ Value:</strong> {{ optimal_mu }}</p>
                            <p><strong>Maximum Distance:</strong> {{ max_achievable_distance }} km</p>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6 plot-container">
                        <h5>Secure Key Rate vs Distance</h5>
                        <img src="data:image/png;base64,{{ plots.key_rate_distance }}" class="img-fluid">
                    </div>
                    <div class="col-md-6 plot-container">
                        <h5>QBER vs Distance</h5>
                        <img src="data:image/png;base64,{{ plots.qber_distance }}" class="img-fluid">
                    </div>
                </div>
                
                <div class="row mt-4">
                    <div class="col-md-6 plot-container">
                        <h5>Secure Key Rate vs Signal State Intensity (μ)</h5>
                        <img src="data:image/png;base64,{{ plots.key_rate_mu }}" class="img-fluid">
                    </div>
                    <div class="col-md-6 plot-container">
                        <h5>Secure Key Rate vs Decoy State Intensity (ν₁)</h5>
                        <img src="data:image/png;base64,{{ plots.key_rate_nu1 }}" class="img-fluid">
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <div class="card">
            <div class="card-header">
                <h3>Welcome to Decoy State QKD Simulator</h3>
            </div>
            <div class="card-body">
                <p>This simulator allows you to explore the behavior of the Decoy State Quantum Key Distribution protocol, an enhanced version of BB84 that improves security against photon-number splitting attacks.</p>
                <p>Adjust the parameters on the left and click "Run Simulation" to see the results.</p>
                <p>The simulator will calculate:</p>
                <ul>
                    <li>Secure Key Rate vs Distance (in bits/second)</li>
                    <li>Quantum Bit Error Rate (QBER) vs Distance</li>
                    <li>Secure Key Rate vs Signal State Intensity (μ) at a specified distance</li>
                    <li>Secure Key Rate vs Decoy State Intensity (ν₁) at a specified distance</li>
                </ul>
                <p>It will also determine key performance metrics like single-photon yield, error rates, and the maximum achievable distance.</p>
                
                <div class="alert alert-info mt-3">
                    <h5>About Decoy State QKD:</h5>
                    <p>Decoy State QKD uses multiple intensity levels to overcome the security vulnerabilities of standard QKD implementations with attenuated laser sources:</p>
                    <ul>
                        <li><strong>Signal State (μ):</strong> Higher intensity pulses used for the actual key generation</li>
                        <li><strong>Decoy State 1 (ν₁):</strong> Medium intensity pulses used to detect photon-number splitting attacks</li>
                        <li><strong>Decoy State 2 (ν₂):</strong> Typically vacuum state (intensity = 0) to estimate background rate</li>
                    </ul>
                    <p>By comparing statistics between different intensity levels, the system can more accurately estimate the contribution of single-photon states to the key, improving security bounds and achievable distances.</p>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>
<!-- Add JavaScript to handle the loading animation -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('simulationForm');
        const pageLoadingOverlay = document.getElementById('pageLoadingOverlay');
        
        form.addEventListener('submit', function(e) {
            // Show the full-page loading overlay
            pageLoadingOverlay.style.display = 'block';
            
            // Allow the form to submit
            return true;
        });
    });
</script>
{% endblock %}