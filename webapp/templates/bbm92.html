{% extends "base.html" %}
{% load static %}
{% block title %}BBM92 QKD Simulator{% endblock %}

{% block content %}

<!-- Full-page loading overlay -->
<div id="pageLoadingOverlay" style="display: none; position: fixed; width: 100%; height: 100%; top: 0; left: 0; background-color: rgba(255, 255, 255, 0.7); backdrop-filter: blur(3px); z-index: 2000;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
        </div>
        <p class="mt-3" style="margin-top: 15px; font-weight: 500;">Running simulation, please wait...</p>
    </div>
</div>
<h1 class="text-center mb-4">BBM92 QKD Simulator</h1>
<div class="row">
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h3>Simulation Parameters</h3>
            </div>
            <div class="card-body">
                <form method="post" id="simulationForm">
                    {% csrf_token %}
                    
                    <h5>Channel Mode</h5>
                    <div class="form-group mb-3">
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="channel_mode" id="fiber_mode" value="fiber" checked>
                            <label class="form-check-label" for="fiber_mode">Fiber Optic</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="channel_mode" id="fso_mode" value="fso">
                            <label class="form-check-label" for="fso_mode">Free Space Optical (FSO)</label>
                        </div>
                    </div>
                    
                    <h5>Source Parameters</h5>
                    <div class="form-group">
                        <label for="mu">Mean Photon Number (μ):</label>
                        <input type="number" class="form-control" id="mu" name="mu" value="0.1" step="0.01" min="0.01" max="2.0">
                    </div>
                    <div class="form-group">
                        <label for="repetition_rate">Repetition Rate (Hz):</label>
                        <input type="number" class="form-control" id="repetition_rate" name="repetition_rate" value="1000000" step="100000" min="100000" max="100000000">
                    </div>
                    
                    <h5>Channel Parameters</h5>
                    <div class="form-group">
                        <label for="distance">Distance (km):</label>
                        <input type="number" class="form-control" id="distance" name="distance" value="10" step="1" min="0" max="500">
                    </div>
                    <div class="form-group">
                        <label for="attenuation">Attenuation (dB/km):</label>
                        <input type="number" class="form-control" id="attenuation" name="attenuation" value="0.2" step="0.01" min="0.01" max="1.0">
                    </div>
                    <div class="form-group">
                        <label for="alice_channel_base_efficiency">Alice Channel Base Efficiency:</label>
                        <input type="number" class="form-control" id="alice_channel_base_efficiency" name="alice_channel_base_efficiency" value="1.0" step="0.01" min="0" max="1.0">
                    </div>
                    <div class="form-group">
                        <label for="bob_channel_base_efficiency">Bob Channel Base Efficiency:</label>
                        <input type="number" class="form-control" id="bob_channel_base_efficiency" name="bob_channel_base_efficiency" value="0.3913" step="0.0001" min="0" max="1.0">
                    </div>
                    
                    <!-- FSO-specific parameters (initially hidden) -->
                    <div id="fso_parameters" style="display: none;">
                        <h5>FSO-Specific Parameters</h5>
                        <div class="form-group">
                            <label for="transmitter_diameter">Transmitter Diameter (m):</label>
                            <input type="number" class="form-control" id="transmitter_diameter" name="transmitter_diameter" value="0.1" step="0.01" min="0.01" max="1.0">
                        </div>
                        <div class="form-group">
                            <label for="receiver_diameter">Receiver Diameter (m):</label>
                            <input type="number" class="form-control" id="receiver_diameter" name="receiver_diameter" value="0.3" step="0.01" min="0.01" max="1.0">
                        </div>
                        <div class="form-group">
                            <label for="beam_divergence">Beam Divergence (mrad):</label>
                            <input type="number" class="form-control" id="beam_divergence" name="beam_divergence" value="1" step="0.1" min="0.1" max="10">
                            <small class="form-text text-muted">Input in mrad, will be converted to radians (1 mrad = 0.001 rad)</small>
                        </div>
                        <div class="form-group">
                            <label for="wavelength">Wavelength (nm):</label>
                            <input type="number" class="form-control" id="wavelength" name="wavelength" value="850" step="1" min="400" max="2000">
                            <small class="form-text text-muted">Input in nm, will be converted to meters</small>
                        </div>
                        <div class="form-group">
                            <label for="pointing_error">Pointing Error (μrad):</label>
                            <input type="number" class="form-control" id="pointing_error" name="pointing_error" value="1" step="0.1" min="0.1" max="100">
                            <small class="form-text text-muted">Input in μrad, will be converted to radians (1 μrad = 1e-6 rad)</small>
                        </div>
                        <div class="form-group">
                            <label for="transmitter_efficiency">Transmitter Optics Efficiency:</label>
                            <input type="number" class="form-control" id="transmitter_efficiency" name="transmitter_efficiency" value="0.9" step="0.01" min="0" max="1.0">
                        </div>
                        <div class="form-group">
                            <label for="receiver_efficiency">Receiver Optics Efficiency:</label>
                            <input type="number" class="form-control" id="receiver_efficiency" name="receiver_efficiency" value="0.9" step="0.01" min="0" max="1.0">
                        </div>
                    </div>
                    
                    <h5>Detector Parameters</h5>
                    <div class="form-group">
                        <label for="alice_detector_efficiency">Alice Detector Efficiency:</label>
                        <input type="number" class="form-control" id="alice_detector_efficiency" name="alice_detector_efficiency" value="0.8" step="0.01" min="0" max="1.0">
                    </div>
                    <div class="form-group">
                        <label for="bob_detector_efficiency">Bob Detector Efficiency:</label>
                        <input type="number" class="form-control" id="bob_detector_efficiency" name="bob_detector_efficiency" value="0.8" step="0.01" min="0" max="1.0">
                    </div>
                    <div class="form-group">
                        <label for="dark_count_rate">Dark Count Rate (counts/second):</label>
                        <input type="number" class="form-control" id="dark_count_rate" name="dark_count_rate" value="1000" step="100" min="0" max="10000">
                    </div>
                    <div class="form-group">
                        <label for="time_window">Time Window (ns):</label>
                        <input type="number" class="form-control" id="time_window" name="time_window" value="1" step="0.1" min="0.1" max="10">
                    </div>
                    
                    <h5>Simulation Range Parameters</h5>
                    <div class="form-group">
                        <label for="mu_min">Minimum μ for plots:</label>
                        <input type="number" class="form-control" id="mu_min" name="mu_min" value="0.01" step="0.01" min="0.01" max="1.0">
                    </div>
                    <div class="form-group">
                        <label for="mu_max">Maximum μ for plots:</label>
                        <input type="number" class="form-control" id="mu_max" name="mu_max" value="1.0" step="0.01" min="0.01" max="2.0">
                    </div>
                    
                    <!-- Dynamic distance ranges based on channel mode -->
                    <div id="fiber_distance_ranges">
                        <div class="form-group">
                            <label for="fiber_distance_max_qber">Maximum Distance for QBER plot (km):</label>
                            <input type="number" class="form-control" id="fiber_distance_max_qber" name="fiber_distance_max_qber" value="300" step="10" min="10" max="500">
                        </div>
                        <div class="form-group">
                            <label for="fiber_distance_max_skr">Maximum Distance for SKR plot (km):</label>
                            <input type="number" class="form-control" id="fiber_distance_max_skr" name="fiber_distance_max_skr" value="300" step="10" min="10" max="500">
                        </div>
                    </div>
                    
                    <div id="fso_distance_ranges" style="display: none;">
                        <div class="form-group">
                            <label for="fso_distance_max_qber">Maximum Distance for QBER plot (km):</label>
                            <input type="number" class="form-control" id="fso_distance_max_qber" name="fso_distance_max_qber" value="100" step="5" min="5" max="300">
                        </div>
                        <div class="form-group">
                            <label for="fso_distance_max_skr">Maximum Distance for SKR plot (km):</label>
                            <input type="number" class="form-control" id="fso_distance_max_skr" name="fso_distance_max_skr" value="50" step="5" min="5" max="200">
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary w-100 mt-3">Run Simulation</button>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-8">
        {% if plots %}
        <div class="card">
            <div class="card-header">
                <h3>Simulation Results {% if channel_mode %}({{ channel_mode|title }} Mode){% endif %}</h3>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <h5>Optimal Parameters:</h5>
                    <p><strong>Optimal μ value:</strong> {{ optimal_mu }}</p>
                    <p><strong>QBER at optimal μ:</strong> {{ optimal_qber }}%</p>
                    <p><strong>SKR at optimal μ:</strong> {{ optimal_skr }} bits/s</p>
                    <p><strong>Maximum distance for secure key:</strong> {{ max_distance }} km</p>
                    {% if channel_mode == "fso" and fso_params %}
                    <h5 class="mt-3">FSO Parameters Used:</h5>
                    <p><strong>Transmitter Diameter:</strong> {{ fso_params.transmitter_diameter }} m</p>
                    <p><strong>Receiver Diameter:</strong> {{ fso_params.receiver_diameter }} m</p>
                    <p><strong>Beam Divergence:</strong> {{ fso_params.beam_divergence|floatformat:6 }} rad</p>
                    <p><strong>Wavelength:</strong> {{ fso_params.wavelength|floatformat:9 }} m</p>
                    <p><strong>Pointing Error:</strong> {{ fso_params.pointing_error|floatformat:8 }} rad</p>
                    {% endif %}
                </div>
                
                <div class="row">
                    <div class="col-md-6 plot-container">
                        <h5>QBER vs μ</h5>
                        <img src="data:image/png;base64,{{ plots.qber_vs_mu }}" class="img-fluid">
                    </div>
                    <div class="col-md-6 plot-container">
                        <h5>Secret Key Rate vs μ</h5>
                        <img src="data:image/png;base64,{{ plots.skr_vs_mu }}" class="img-fluid">
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6 plot-container">
                        <h5>QBER vs Distance</h5>
                        <img src="data:image/png;base64,{{ plots.qber_vs_distance }}" class="img-fluid">
                    </div>
                    <div class="col-md-6 plot-container">
                        <h5>Secret Key Rate vs Distance</h5>
                        <img src="data:image/png;base64,{{ plots.skr_vs_distance }}" class="img-fluid">
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <div class="card">
            <div class="card-header">
                <h3>Welcome to BBM92 QKD Simulator</h3>
            </div>
            <div class="card-body">
                <p>This simulator allows you to explore the behavior of the BBM92 quantum key distribution protocol under different conditions.</p>
                <p>You can now choose between two channel modes:</p>
                <ul>
                    <li><strong>Fiber Optic</strong> - Simulates transmission through optical fibers with linear attenuation</li>
                    <li><strong>Free Space Optical (FSO)</strong> - Simulates transmission through free space with beam divergence, atmospheric effects, and pointing errors</li>
                </ul>
                <p>Adjust the parameters on the left and click "Run Simulation" to see the results.</p>
                <p>The simulator will calculate:</p>
                <ul>
                    <li>Quantum Bit Error Rate (QBER) vs Mean Photon Number (μ)</li>
                    <li>Secret Key Rate (SKR) vs Mean Photon Number (μ) in bits/second</li>
                    <li>QBER vs Distance</li>
                    <li>SKR vs Distance in bits/second</li>
                </ul>
                <p>It will also determine the optimal mean photon number and maximum secure distance.</p>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Add JavaScript to handle the loading animation and channel mode switching -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('simulationForm');
        const pageLoadingOverlay = document.getElementById('pageLoadingOverlay');
        const fiberMode = document.getElementById('fiber_mode');
        const fsoMode = document.getElementById('fso_mode');
        const fsoParameters = document.getElementById('fso_parameters');
        const fiberDistanceRanges = document.getElementById('fiber_distance_ranges');
        const fsoDistanceRanges = document.getElementById('fso_distance_ranges');
        
        // Function to toggle FSO parameters visibility
        function toggleFsoParameters() {
            if (fsoMode.checked) {
                fsoParameters.style.display = 'block';
                fiberDistanceRanges.style.display = 'none';
                fsoDistanceRanges.style.display = 'block';
            } else {
                fsoParameters.style.display = 'none';
                fiberDistanceRanges.style.display = 'block';
                fsoDistanceRanges.style.display = 'none';
            }
        }
        
        // Add event listeners for channel mode radio buttons
        fiberMode.addEventListener('change', toggleFsoParameters);
        fsoMode.addEventListener('change', toggleFsoParameters);
        
        // Initialize state based on any existing selection
        toggleFsoParameters();
        
        // Process form submission
        form.addEventListener('submit', function(e) {
            // Convert units for FSO parameters if FSO mode is selected
            if (fsoMode.checked) {
                e.preventDefault(); // Prevent default form submission
                
                // Convert mrad to radians for beam divergence
                const beamDivergence = document.getElementById('beam_divergence');
                const beamDivergenceValue = parseFloat(beamDivergence.value) * 0.001; // mrad to rad
                
                // Convert nm to meters for wavelength
                const wavelength = document.getElementById('wavelength');
                const wavelengthValue = parseFloat(wavelength.value) * 1e-9; // nm to m
                
                // Convert μrad to radians for pointing error
                const pointingError = document.getElementById('pointing_error');
                const pointingErrorValue = parseFloat(pointingError.value) * 1e-6; // μrad to rad
                
                // Create hidden inputs for the converted values
                const hiddenBeamDivergence = document.createElement('input');
                hiddenBeamDivergence.type = 'hidden';
                hiddenBeamDivergence.name = 'beam_divergence';
                hiddenBeamDivergence.value = beamDivergenceValue;
                
                const hiddenWavelength = document.createElement('input');
                hiddenWavelength.type = 'hidden';
                hiddenWavelength.name = 'wavelength';
                hiddenWavelength.value = wavelengthValue;
                
                const hiddenPointingError = document.createElement('input');
                hiddenPointingError.type = 'hidden';
                hiddenPointingError.name = 'pointing_error';
                hiddenPointingError.value = pointingErrorValue;
                
                // Append hidden inputs to form
                form.appendChild(hiddenBeamDivergence);
                form.appendChild(hiddenWavelength);
                form.appendChild(hiddenPointingError);
            }
            
            // Show the full-page loading overlay
            pageLoadingOverlay.style.display = 'block';
            
            // Allow the form to submit
            if (fsoMode.checked) {
                form.submit();
            }
            return true;
        });
    });
</script>
{% endblock %}