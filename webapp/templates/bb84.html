{% extends "base.html" %}
{% block title %}BB84 QKD Simulator{% endblock %}

{% block content %}
<!-- Full-page loading overlay -->
<div id="pageLoadingOverlay" style="display: none; position: fixed; width: 100%; height: 100%; top: 0; left: 0; background-color: rgba(255, 255, 255, 0.7); backdrop-filter: blur(3px); z-index: 2000;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
        </div>
        <p class="mt-3" style="margin-top: 15px; font-weight: 500;">Running simulation, please wait...</p>
    </div>
</div>

<div class="container mt-5">
    <h1 class="text-center mb-4">BB84 Quantum Key Distribution Simulator</h1>
    
    <div class="row">
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5>Simulation Parameters</h5>
                </div>
                <div class="card-body">
                    <form method="post" id="simulationForm">
                        {% csrf_token %}
                        
                        <!-- Channel Mode Selection -->
                        <div class="form-group mb-3">
                            <label for="channel_mode">Channel Mode:</label>
                            <select class="form-control" id="channel_mode" name="channel_mode">
                                <option value="fiber" {% if form_data.channel_mode == 'fiber' %}selected{% endif %}>Fiber Optic</option>
                                <option value="fso" {% if form_data.channel_mode == 'fso' %}selected{% endif %}>Free Space Optical (FSO)</option>
                            </select>
                        </div>
                        
                        <div class="form-group mb-3">
                            <label for="mu">Mean Photon Number (μ):</label>
                            <input type="number" class="form-control" id="mu" name="mu" min="0.01" step="0.01" value="{{ form_data.mu }}">
                        </div>
                        
                        <div class="form-group mb-3">
                            <label for="distance">Distance (km):</label>
                            <input type="number" class="form-control" id="distance" name="distance" min="0" step="0.1" value="{{ form_data.distance }}">
                        </div>
                        
                        <!-- Fiber-specific parameter -->
                        <div class="form-group mb-3 fiber-param">
                            <label for="attenuation">Fiber Attenuation (dB/km):</label>
                            <input type="number" class="form-control" id="attenuation" name="attenuation" min="0.1" step="0.01" value="{{ form_data.attenuation }}">
                        </div>
                        
                        <!-- FSO-specific parameters -->
                        <div id="fso-params" style="display: none;">
                            <div class="form-group mb-3">
                                <label for="transmitter_diameter">Transmitter Diameter (m):</label>
                                <input type="number" class="form-control" id="transmitter_diameter" name="transmitter_diameter" min="0.01" step="0.01" value="{{ form_data.transmitter_diameter|default:0.1 }}">
                            </div>
                            
                            <div class="form-group mb-3">
                                <label for="receiver_diameter">Receiver Diameter (m):</label>
                                <input type="number" class="form-control" id="receiver_diameter" name="receiver_diameter" min="0.01" step="0.01" value="{{ form_data.receiver_diameter|default:0.3 }}">
                            </div>
                            
                            <div class="form-group mb-3">
                                <label for="beam_divergence">Beam Divergence (mrad):</label>
                                <input type="number" class="form-control" id="beam_divergence" name="beam_divergence" min="0.001" step="0.001" value="{{ form_data.beam_divergence|default:1 }}">
                            </div>
                            
                            <div class="form-group mb-3">
                                <label for="wavelength">Wavelength (nm):</label>
                                <input type="number" class="form-control" id="wavelength" name="wavelength" min="400" step="1" value="{{ form_data.wavelength|default:850 }}">
                            </div>
                            
                            <div class="form-group mb-3">
                                <label for="pointing_error">Pointing Error (μrad):</label>
                                <input type="number" class="form-control" id="pointing_error" name="pointing_error" min="0.1" step="0.1" value="{{ form_data.pointing_error|default:1 }}">
                            </div>
                        </div>
                        
                        <div class="form-group mb-3">
                            <label for="detector_efficiency">Detector Efficiency:</label>
                            <input type="number" class="form-control" id="detector_efficiency" name="detector_efficiency" min="0.01" max="1" step="0.01" value="{{ form_data.detector_efficiency }}">
                        </div>
                        
                        <div class="form-group mb-3">
                            <label for="channel_base_efficiency">Channel Base Efficiency:</label>
                            <input type="number" class="form-control" id="channel_base_efficiency" name="channel_base_efficiency" min="0.01" max="1" step="0.01" value="{{ form_data.channel_base_efficiency }}">
                        </div>
                        
                        <div class="form-group mb-3">
                            <label for="dark_count_rate">Dark Count Rate (counts/s):</label>
                            <input type="number" class="form-control" id="dark_count_rate" name="dark_count_rate" min="0" step="100" value="{{ form_data.dark_count_rate }}">
                        </div>
                        
                        <div class="form-group mb-3">
                            <label for="time_window">Time Window (ns):</label>
                            <input type="number" class="form-control" id="time_window" name="time_window" min="0.1" step="0.1" value="{{ form_data.time_window }}">
                        </div>
                        
                        <div class="form-group mb-3">
                            <label for="repetition_rate">Repetition Rate (Hz):</label>
                            <input type="number" class="form-control" id="repetition_rate" name="repetition_rate" min="1000" step="1000" value="{{ form_data.repetition_rate }}">
                        </div>
                        
                        <div class="form-group mb-3">
                            <label for="p_eve">Eavesdropping Probability:</label>
                            <input type="number" class="form-control" id="p_eve" name="p_eve" min="0" max="1" step="0.01" value="{{ form_data.p_eve }}">
                        </div>
                        
                        <!-- Plot Range Parameters - with different defaults for FSO -->
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">Plot Range Settings</h6>
                            </div>
                            <div class="card-body">
                                <div class="form-group mb-3">
                                    <label for="mu_min">μ Range Min:</label>
                                    <input type="number" class="form-control" id="mu_min" name="mu_min" min="0.01" step="0.01" value="{{ form_data.mu_min }}">
                                </div>
                                
                                <div class="form-group mb-3">
                                    <label for="mu_max">μ Range Max:</label>
                                    <input type="number" class="form-control" id="mu_max" name="mu_max" min="0.1" step="0.1" value="{{ form_data.mu_max }}">
                                </div>
                                
                                <div class="form-group mb-3">
                                    <label for="distance_max_qber">Max Distance for QBER (km):</label>
                                    <input type="number" class="form-control" id="distance_max_qber" name="distance_max_qber" min="1" step="1" value="{{ form_data.distance_max_qber }}">
                                </div>
                                
                                <div class="form-group mb-3">
                                    <label for="distance_max_skr">Max Distance for SKR (km):</label>
                                    <input type="number" class="form-control" id="distance_max_skr" name="distance_max_skr" min="1" step="1" value="{{ form_data.distance_max_skr }}">
                                </div>
                                
                                <div class="form-group mb-3">
                                    <label for="p_eve_max">Max Eavesdropping Probability:</label>
                                    <input type="number" class="form-control" id="p_eve_max" name="p_eve_max" min="0.1" max="1" step="0.1" value="{{ form_data.p_eve_max }}">
                                </div>
                            </div>
                        </div>
                        
                        <button type="submit" class="btn btn-primary w-100">Simulate</button>
                    </form>
                </div>
            </div>
        </div>
        
        {% if submission %}
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-header">
                    <h5>Simulation Results</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="alert alert-info">
                                <h6>Optimal Parameters:</h6>
                                <ul class="list-unstyled">
                                    <li>Optimal μ: {{ optimal_mu }}</li>
                                    <li>QBER at optimal μ: {{ optimal_qber }}%</li>
                                    <li>SKR at optimal μ: {{ optimal_skr }} bits/s</li>
                                    <li>Maximum secure distance: {{ max_distance }} km</li>
                                </ul>
                            </div>
                        </div>
                        <!-- <div class="col-md-6">
                            <div class="alert alert-secondary">
                                <h6>Current Channel Properties:</h6>
                                <ul class="list-unstyled">
                                    <li>Channel mode: <strong>{{ form_data.channel_mode|upper }}</strong></li>
                                    <li>Channel efficiency: {{ channel_efficiency }}%</li>
                                    <li>Photon distribution (0-4 photons):</li>
                                    <li>0 photons: {{ photon_percentages.0 }}%</li>
                                    <li>1 photon: {{ photon_percentages.1 }}%</li>
                                    <li>2+ photons: {{ photon_percentages.2 }}% + ...</li>
                                </ul>
                            </div>
                        </div> -->
                    </div>
                    
                    <!-- Display all graphs in a grid -->
                    <h5 class="mt-3 mb-3">Simulation Graphs</h5>
                    
                    <div class="row">
                        <!-- First row of graphs -->
                        <div class="col-md-6 mb-3">
                            <div class="card">
                                <div class="card-header">QBER vs Mean Photon Number</div>
                                <div class="card-body">
                                    <img src="data:image/png;base64,{{ plots.qber_vs_mu }}" class="img-fluid" alt="QBER vs Mean Photon Number">
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="card">
                                <div class="card-header">SKR vs Mean Photon Number</div>
                                <div class="card-body">
                                    <img src="data:image/png;base64,{{ plots.skr_vs_mu }}" class="img-fluid" alt="SKR vs Mean Photon Number">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Second row of graphs -->
                        <div class="col-md-6 mb-3">
                            <div class="card">
                                <div class="card-header">QBER vs Distance</div>
                                <div class="card-body">
                                    <img src="data:image/png;base64,{{ plots.qber_vs_distance }}" class="img-fluid" alt="QBER vs Distance">
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="card">
                                <div class="card-header">SKR vs Distance</div>
                                <div class="card-body">
                                    <img src="data:image/png;base64,{{ plots.skr_vs_distance }}" class="img-fluid" alt="SKR vs Distance">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Third row of graphs -->
                        <div class="col-md-6 mb-3">
                            <div class="card">
                                <div class="card-header">QBER vs Eavesdropping Probability</div>
                                <div class="card-body">
                                    <img src="data:image/png;base64,{{ plots.qber_vs_eve }}" class="img-fluid" alt="QBER vs Eavesdropping">
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="card">
                                <div class="card-header">SKR vs Eavesdropping Probability</div>
                                <div class="card-body">
                                    <img src="data:image/png;base64,{{ plots.skr_vs_eve }}" class="img-fluid" alt="SKR vs Eavesdropping">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h5>BB84 Protocol Explanation</h5>
                </div>
                <div class="card-body">
                    <p>The BB84 protocol, developed by Charles Bennett and Gilles Brassard in 1984, is the first quantum key distribution protocol. It uses quantum properties to establish a secure key between two parties:</p>
                    
                    <ol>
                        <li><strong>Photon Transmission:</strong> Alice sends photons with random polarization in one of two bases to Bob.</li>
                        <li><strong>Measurement:</strong> Bob measures each photon in a randomly chosen basis.</li>
                        <li><strong>Basis Reconciliation:</strong> Alice and Bob publicly compare the bases they used and keep only the results where they chose the same basis.</li>
                        <li><strong>Error Estimation:</strong> They check for errors which may indicate eavesdropping.</li>
                        <li><strong>Privacy Amplification:</strong> They apply information-theoretic techniques to distill a shorter but more secure key.</li>
                    </ol>
                    
                    <p><strong>Key Parameters:</strong></p>
                    <ul>
                        <li><strong>Mean Photon Number (μ):</strong> Controls the average number of photons per pulse. Higher values increase bit rate but also vulnerability to photon-number-splitting attacks.</li>
                        <li><strong>QBER:</strong> Quantum Bit Error Rate - indicates the percentage of errors. Values below 11% allow secure key generation.</li>
                        <li><strong>Distance:</strong> Fiber length between Alice and Bob. Longer distances increase attenuation and error rates.</li>
                    </ul>
                    
                    <div class="alert alert-info mt-3">
                        <h6 class="mb-2">Channel Modes:</h6>
                        <p class="mb-1"><strong>Fiber Optic:</strong> Traditional telecom fiber with exponential attenuation (typically 0.2 dB/km).</p>
                        <p class="mb-0"><strong>Free Space Optical (FSO):</strong> Transmission through air/vacuum, affected by geometric loss, beam wandering, and atmospheric turbulence.</p>
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5>BB84 Quantum Key Distribution</h5>
                </div>
                <div class="card-body">
                    <p>Welcome to the BB84 protocol simulator. Adjust the parameters on the left and click "Simulate" to analyze the performance of the BB84 quantum key distribution protocol.</p>
                    
                    <h5>What is BB84?</h5>
                    <p>BB84 is the first quantum key distribution protocol, proposed by Charles Bennett and Gilles Brassard in 1984. It allows two parties (traditionally called Alice and Bob) to establish a secure cryptographic key by transmitting quantum states.</p>
                    
                    <h5>Key Concepts:</h5>
                    <ul>
                        <li><strong>Weak Coherent Pulses:</strong> This simulator uses attenuated laser pulses which follow a Poisson photon number distribution.</li>
                        <li><strong>Quantum Bit Error Rate (QBER):</strong> Measures the proportion of errors in the raw key, critical for detecting eavesdropping.</li>
                        <li><strong>Secret Key Rate (SKR):</strong> The final rate at which secure key bits can be generated after all processing steps.</li>
                    </ul>
                    
                    <h5>Available Channel Types:</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-header bg-light">Fiber Optic Channel</div>
                                <div class="card-body">
                                    <p>Traditional optical fiber with exponential attenuation.</p>
                                    <ul>
                                        <li>Typical attenuation: 0.2 dB/km at 1550 nm</li>
                                        <li>Suitable for terrestrial links up to ~100-200 km</li>
                                        <li>Stable transmission environment</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-header bg-light">Free Space Optical (FSO) Channel</div>
                                <div class="card-body">
                                    <p>Transmission through air or vacuum.</p>
                                    <ul>
                                        <li>Affected by beam divergence and pointing</li>
                                        <li>Suitable for satellite-to-ground links</li>
                                        <li>More rapid attenuation with distance</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        Adjust the parameters and click "Simulate" to see how they affect the performance of the BB84 protocol.
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Add JavaScript to handle the loading animation and toggle FSO parameters -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('simulationForm');
        const pageLoadingOverlay = document.getElementById('pageLoadingOverlay');
        const channelModeSelect = document.getElementById('channel_mode');
        const fsoParamsDiv = document.getElementById('fso-params');
        const fiberParams = document.querySelectorAll('.fiber-param');
        const distanceMaxQber = document.getElementById('distance_max_qber');
        const distanceMaxSkr = document.getElementById('distance_max_skr');
        const distanceInput = document.getElementById('distance');
        
        // Function to toggle FSO parameters visibility
        function toggleFsoParams() {
            if (channelModeSelect.value === 'fso') {
                fsoParamsDiv.style.display = 'block';
                fiberParams.forEach(elem => elem.style.display = 'none');
                
                // Set FSO default values if not already set by user
                if (!form.dataset.userModified) {
                    distanceMaxQber.value = '20';  // 20 km max for QBER plots in FSO mode
                    distanceMaxSkr.value = '5';    // 5 km max for SKR plots in FSO mode
                    distanceInput.value = '1';     // 1 km default distance for FSO
                }
            } else {
                fsoParamsDiv.style.display = 'none';
                fiberParams.forEach(elem => elem.style.display = 'block');
                
                // Restore fiber default values if not already set by user
                if (!form.dataset.userModified) {
                    distanceMaxQber.value = '120';  // 120 km max for QBER plots in fiber mode
                    distanceMaxSkr.value = '120';   // 120 km max for SKR plots in fiber mode
                    distanceInput.value = '50';     // 50 km default distance for fiber
                }
            }
        }
        
        // Set initial state
        toggleFsoParams();
        
        // Add change event listener to channel mode select
        channelModeSelect.addEventListener('change', toggleFsoParams);
        
        // Mark the form as user modified when input fields are changed
        const allInputs = form.querySelectorAll('input, select');
        allInputs.forEach(input => {
            input.addEventListener('change', function() {
                form.dataset.userModified = 'true';
            });
        });
        
        // Handle form submission
        form.addEventListener('submit', function(e) {
            // Show the full-page loading overlay
            pageLoadingOverlay.style.display = 'block';
            
            // Allow the form to submit
            return true;
        });
    });
</script>
{% endblock %}